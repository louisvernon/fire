<html>
<head>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        
<style>

* {
  box-sizing: border-box;
}

h2 {
  width: 100%;
  text-align: center;
  margin: 4px;
  padding: 4px;
}

div.input {
  display: inline-block;
  width: 100%;
}

.modelInput {
  display: inline-block;
  width: 25%;
  text-align: center;
}

button.input {
  display: inline-block;
}

label.input {
  display: inline-block;
  width: 40%;
  text-align: right;
}

/* Create four equal columns that floats next to each other */
.column {
  float: left;
  width: 25%;
  padding: 2px;
  height: 250px;
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

/* Responsive layout - makes the four columns stack on top of each other instead of next to each other */
@media screen and (max-width: 600px) {
  .column {
    width: 100%;
  }
}

</style>
</head>

<body>

  <div class="row">
    <div class="column" style="background-color:#aaa;">

      <h2>Current Balance</h2>
      <div class="input">          
      <label class="input">Regular:</label> 
      <input id="balances-regular" value="100000" class="modelInput">
      </div>
      <div class="input">        
      <label class="input"> 401K:</label> 
      <input id="balances-401k" value="100000" class="modelInput">   
      </div>
      <div class="input">         
      <label class="input">  IRA:</label> 
      <input id="balances-ira" value="30000" class="modelInput">
      </div>
      <div class="input">       
      <label class="input">IRA Basis (optional):</label>
      <input id="ira-basis" value="20000" class="modelInput">
      </div>
      <h2>Target Balance</h2>
      <div class="input">          
      <label class="input">Estate:</label> 
      <input id="target" value="100000" class="modelInput">
      </div>


    </div>
    <div class="column" style="background-color:#bbb;">

        <h2>Annual Contributions</h2>
        <div class="input">          
        <label class="input">Regular:</label> 
        <input id="contributions-regular" value="20000" class="modelInput">
        </div>
        <div class="input">        
        <label class="input"> 401K:</label> 
        <input id="contributions-401k" value="20000" class="modelInput">   
        </div>
        <div class="input">         
        <label class="input">  IRA:</label> 
        <input id="contributions-ira" value="6000" class="modelInput">
        </div>
        <div class="input">
        <label class="input">  Fixed Income:</label>
        <input id="income-fixed" value="0" class="modelInput">
        </div>
        <h2>Annual Social Security</h2>
        <div class="input">         
        <label class="input">Estimate:</label> 
        <input id="income-ss" value="20000" class="modelInput">
        </div>        

    </div>
    <div class="column" style="background-color:#ccc;">
      <h2>Annual Expenses</h2>
      <div class="input">         
        <label class="input">Regular:</label> 
        <input id="expenses" value="100000" class="modelInput">
        <button name="fit-expenses" class="modelFit">Fit</button>
        </div>               
      <h2>Annual Compounding</h2>
      <div class="input">
        <label class="input">Yield (%):</label> 
        <input id="roi" value="7" class="modelInput">
        <label class="input">Inflation (%):</label> 
        <input id="inflation" value="2.5" class="modelInput">
        </div>
    </div>
    <div class="column" style="background-color:#ddd;">
      <h2>Milestones</h2>

        <div class="input">          
        <label class="input">Current Age:</label> 
        <input id="now" value="30" class="modelInput">
        </div>
        <div class="input">        
        <label class="input">Early Retirement:</label> 
        <input id="early_retirement" value="50" class="modelInput">   
        </div>
        <div class="input">         
        <label class="input">Full Retirement:</label> 
        <input id="full_retirement" value="60" class="modelInput">
        </div>
        <div class="input">         
        <label class="input">Collect Social:</label> 
        <input id="social_security" value="67" class="modelInput">
        </div>        
        <div class="input">         
        <label class="input">Death â˜ :</label> 
        <input id="death" value="95" class="modelInput">
        </div>           
    </div>
  </div>

<div id="retirement" style="width:100%;height:50%;"></div>
<script>

function get_config() {
  var localStorage;
  try {
    localStorage = window.localStorage;
  } catch(e) {
    console.log("localstorage not available.")
  }
  var inputs = document.getElementsByClassName("modelInput");
  for (var i = 0; i < inputs.length; i++) {
    if(inputs[i].id in localStorage) {
      inputs[i].value = localStorage.getItem(inputs[i].id);
    }
  }
}

function set_config() {
  var localStorage;
  try {
    localStorage = window.localStorage;
  } catch(e) {
    console.log("localstorage not available.")
  }
  var inputs = document.getElementsByClassName("modelInput");
  for (var i = 0; i < inputs.length; i++) {
      localStorage.setItem(inputs[i].id, inputs[i].value);
  }
}


function run_estimate (render_graph = true) {
  set_config();
  var balances = {};
  balances["Regular"] = parseFloat($("#balances-regular").val());
  balances["401k"] = parseFloat($("#balances-401k").val());
  balances["IRA"] = parseFloat($("#balances-ira").val());
  var target = parseInt($("#target").val());
  var ira_basis=parseFloat($("#ira-basis").val());

  var contributions = {}
  contributions["Regular"] = parseFloat($("#contributions-regular").val());
  contributions["401k"] = parseFloat($("#contributions-401k").val());
  contributions["IRA"] = parseFloat($("#contributions-ira").val());
  var income_ss = parseFloat($("#income-ss").val());
  var income_fixed = parseFloat($("#income-fixed").val());

  var expenses = parseFloat($("#expenses").val());

  var inflation = parseFloat($("#inflation").val())/100;
  var roi = parseFloat($("#roi").val())/100;

  var ages = {};
  ages["Now"] = parseFloat($("#now").val());
  ages["Early Retirement"] = parseFloat($("#early_retirement").val());
  ages["Full Retirement"] = parseFloat($("#full_retirement").val());
  ages["Death"] = parseFloat($("#death").val());
  ages["Collect Social"] = parseFloat($("#social_security").val());

  var timeline = [ages["Now"]];
  var balance = {};
  var total_balance = 0;
  for (const account in balances) total_balance += balances[account];
  var net_worth = [total_balance];

  for (const account in balances) balance[account] = [balances[account]];
  for (age = ages["Now"] + 1; age <= ages["Death"]; age++) {
    timeline.push(age);
    var now = age-ages["Now"];
    var prev = now-1;
    var todays_expenses = expenses;
    // start this years balance off as equal to last years
    for (const account in balance) {
      balance[account].push(balance[account][prev]);
    }
    balance["Regular"][now] += income_fixed;
    if (age >= ages["Collect Social"]) balance["Regular"][now] += income_ss;
    if (age < ages["Early Retirement"]) {
      // if not retired add contributions
      for (const account in balance) balance[account][now] += contributions[account];
      // roth ira basis is a special case
      ira_basis += contributions["IRA"];
    } else {
      // you are retired, drawdown in order of dict
      for (const account in balance) {
        balance[account][now] -= todays_expenses;
        if (balance[account][now] < 0) {
          todays_expenses = -balance[account][now];
          balance[account][now] = 0;
        } else {
          todays_expenses = 0;
        }
      }
    } 

    // Growth is applied to average value during year
    for (const account in balance) {
      if(balance[account][now]>1) {
        balance[account][now] += (balance[account][prev]+balance[account][now]) * (roi) / 2;
      }
    }

    total_balance = 0;
    for (const account in balance) total_balance +=  balance[account][now];
    net_worth.push(total_balance);

    // expenses and contributions grow with inflation
    expenses *= (1+inflation);
    for (const account in contributions) contributions[account] *= (1+inflation); 
  }
  
  if(render_graph) {

    var data = []

    data.push( {
      x: timeline,
      y: net_worth,
      mode: 'lines',
      type: 'scatter',
      line: {
        dash: 'dot',
        width: 4
      },
      name: 'Net Worth',
      hoverinfo: "y"
    } );


    for (const account in balance) {
      data.push( {
        x: timeline,
        y: balance[account],
        mode: 'lines',
        type: 'scatter',
        name: account,
        hoverinfo: "y"
      } );
    }

    var layout = {
      annotations: [],
      yaxis: {fixedrange: true, hoverformat: '.2s'},
      xaxis : {fixedrange: true}
    };

    for (milestone in ages) {
    layout["annotations"].push({
        x: ages[milestone],
        y: 0,
        xref: 'x',
        yref: 'y',
        text: milestone,
        showarrow: true,
        arrowhead: 7,
        ax: 0,
        ay: 20
      }
    );
    }

    if(target != 0) {
        layout["annotations"].push({
        x: ages["Death"],
        y: target,
        xref: 'x',
        yref: 'y',
        text: "Desired Estate",
        showarrow: true,
        arrowhead: 7,
        ax: ages["Death"]+5,
        ay: 0
      }
    );
    }
    retirement = document.getElementById('retirement');
    Plotly.newPlot(retirement, data, layout, {displayModeBar: false});
  }
  return total_balance - todays_expenses;


}

function fit_value() {
  var remainder = run_estimate(render_graph=false);
  var target = parseInt($("#target").val());
  var sign = Math.sign(remainder-target);
  if (remainder == target) {
    return;
  } else {
    while ((remainder-target) * sign > 0) {
      $("#expenses").val(parseInt($("#expenses").val()) + sign*10);
      remainder = run_estimate(render_graph=false);
    }
    run_estimate();
  }
}


var inputs = document.getElementsByClassName("modelInput");
for (var i = 0; i < inputs.length; i++) inputs[i].onchange = run_estimate;

var inputs = document.getElementsByClassName("modelFit");
for (var i = 0; i < inputs.length; i++) inputs[i].onclick = fit_value;

get_config();
run_estimate();

window.onresize = run_estimate;

</script>
</body>
</html>
